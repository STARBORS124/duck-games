<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ü¶Ü DUCK GAMES</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background: #0F172A;
            min-height: 100vh;
            padding: 16px;
            position: relative;
            overflow-x: hidden;
        }

        /* –§–æ–Ω–æ–≤—ã–µ —ç–º–æ–¥–∑–∏ */
        .bg-emoji {
            position: fixed;
            pointer-events: none;
            z-index: 0;
            font-size: 24px;
            opacity: 0.1;
            animation: float 10s infinite linear;
            user-select: none;
        }

        @keyframes float {
            0% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(5deg); }
            100% { transform: translateY(0) rotate(0deg); }
        }

        /* –ó–≤–µ–∑–¥–æ—á–∫–∏ */
        .star-1 { top: 5%; left: 3%; animation-delay: 0s; font-size: 28px; }
        .star-2 { top: 15%; right: 8%; animation-delay: 1s; font-size: 32px; }
        .star-3 { top: 45%; left: 12%; animation-delay: 2s; font-size: 24px; }
        .star-4 { top: 70%; right: 15%; animation-delay: 3s; font-size: 36px; }
        .star-5 { top: 85%; left: 20%; animation-delay: 4s; font-size: 30px; }
        .star-6 { top: 25%; right: 25%; animation-delay: 5s; font-size: 26px; }
        .star-7 { top: 60%; left: 30%; animation-delay: 6s; font-size: 34px; }
        
        /* –ú–æ–Ω–µ—Ç–∫–∏ */
        .coin-1 { top: 8%; left: 40%; animation-delay: 0.5s; font-size: 32px; }
        .coin-2 { top: 35%; right: 35%; animation-delay: 1.5s; font-size: 28px; }
        .coin-3 { top: 55%; left: 50%; animation-delay: 2.5s; font-size: 36px; }
        .coin-4 { top: 80%; right: 45%; animation-delay: 3.5s; font-size: 30px; }
        .coin-5 { top: 20%; left: 70%; animation-delay: 4.5s; font-size: 26px; }
        .coin-6 { top: 65%; right: 60%; animation-delay: 5.5s; font-size: 34px; }

        /* –£—Ç–∫–∏ –∏–∑ –≤–∞—à–µ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏ */
        .duck-bg {
            position: fixed;
            pointer-events: none;
            z-index: 0;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            opacity: 0.08;
        }

        .duck-1 {
            top: 10%;
            left: 5%;
            width: 150px;
            height: 150px;
            background-image: url('https://i.postimg.cc/yW9QCMbb/izobrazenie-2026-02-14-182819036.png');
            transform: rotate(-5deg);
        }

        .duck-2 {
            bottom: 15%;
            right: 5%;
            width: 180px;
            height: 180px;
            background-image: url('https://avatars.mds.yandex.net/i?id=124bd57b260e8a4e4661daa0de7ad51486ff1663-9033858-images-thumbs&n=13');
            transform: rotate(10deg) scaleX(-1);
        }

        .duck-3 {
            top: 40%;
            right: 10%;
            width: 130px;
            height: 130px;
            background-image: url('https://i.postimg.cc/yW9QCMbb/izobrazenie-2026-02-14-182819036.png');
            transform: rotate(15deg);
        }

        .app {
            max-width: 500px;
            margin: 0 auto;
            position: relative;
            z-index: 10;
        }

        .header {
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 28px;
            padding: 16px 20px;
            margin-bottom: 20px;
            border: 1px solid #FBBF24;
            box-shadow: 0 8px 0 #0F172A;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .duck-icon {
            width: 44px;
            height: 44px;
            background: #FBBF24;
            border-radius: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 0 #B45309;
        }

        .logo-text {
            font-size: 22px;
            font-weight: 700;
            color: #FBBF24;
            text-shadow: 0 2px 0 #B45309;
        }

        .balance-box {
            background: #0F172A;
            border-radius: 40px;
            padding: 8px 16px;
            border: 2px solid #FBBF24;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
        }

        .balance-box.sync {
            border-color: #34D399;
            box-shadow: 0 0 15px #34D399;
        }

        .star-icon {
            font-size: 20px;
            color: #FBBF24;
        }

        .balance-num {
            font-size: 22px;
            font-weight: 700;
            color: #FBBF24;
        }

        .balance-label {
            font-size: 12px;
            color: #94A3B8;
        }

        .global-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 24px;
        }

        .global-stat-card {
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(5px);
            border-radius: 20px;
            padding: 12px 4px;
            text-align: center;
            border: 1px solid #FBBF24;
        }

        .global-stat-value {
            font-size: 18px;
            font-weight: 700;
            color: #FBBF24;
        }

        .global-stat-label {
            font-size: 10px;
            color: #94A3B8;
            margin-top: 4px;
        }

        .menu-title {
            font-size: 18px;
            color: #FBBF24;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .games-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .game-card {
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(5px);
            border-radius: 24px;
            padding: 24px 16px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
            box-shadow: 0 6px 0 #0F172A;
            text-align: center;
        }

        .game-card:hover {
            border-color: #FBBF24;
            transform: translateY(-4px);
            box-shadow: 0 10px 0 #0F172A;
        }

        .card-emoji {
            font-size: 56px;
            margin-bottom: 12px;
            filter: drop-shadow(0 4px 4px #00000066);
        }

        .card-name {
            font-size: 20px;
            font-weight: 700;
            color: #FBBF24;
            margin-bottom: 4px;
        }

        .card-stats {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 12px;
            font-size: 12px;
        }

        .card-stat {
            background: #0F172A;
            padding: 4px 10px;
            border-radius: 20px;
            color: #FBBF24;
        }

        .game-menu {
            display: none;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 28px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #FBBF24;
            box-shadow: 0 8px 0 #0F172A;
        }

        .game-menu-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid #FBBF24;
        }

        .game-menu-emoji {
            font-size: 48px;
            background: #0F172A;
            width: 80px;
            height: 80px;
            border-radius: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #FBBF24;
        }

        .game-menu-info h2 {
            font-size: 28px;
            font-weight: 700;
            color: #FBBF24;
        }

        .game-menu-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .game-menu-stat {
            background: #0F172A;
            border-radius: 16px;
            padding: 12px 4px;
            text-align: center;
            border: 1px solid #FBBF24;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: #FBBF24;
        }

        .stat-label {
            font-size: 10px;
            color: #94A3B8;
        }

        .game-menu-history {
            background: #0F172A;
            border-radius: 20px;
            padding: 16px;
            margin-bottom: 20px;
            border: 1px solid #FBBF24;
        }

        .history-title {
            font-size: 16px;
            color: #FBBF24;
            margin-bottom: 12px;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 16px;
            background: #1E293B;
            border-radius: 16px;
            font-size: 14px;
        }

        .history-win { color: #FBBF24; }
        .history-lose { color: #94A3B8; }

        .history-amount-win {
            background: #FBBF24;
            color: #0F172A;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
        }

        .history-amount-lose {
            background: #475569;
            color: #FBBF24;
            padding: 4px 12px;
            border-radius: 20px;
        }

        .game-menu-buttons {
            display: flex;
            gap: 12px;
        }

        .menu-btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 40px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .menu-btn.play {
            background: #FBBF24;
            color: #0F172A;
            box-shadow: 0 6px 0 #B45309;
        }

        .menu-btn.play:hover {
            transform: translateY(-3px);
            box-shadow: 0 9px 0 #B45309;
        }

        .menu-btn.back {
            background: #475569;
            color: #FBBF24;
            box-shadow: 0 6px 0 #1E293B;
        }

        .game-play-area {
            display: none;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 28px;
            padding: 24px;
            border: 2px solid #FBBF24;
            box-shadow: 0 8px 0 #0F172A;
        }

        .play-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .play-title {
            font-size: 24px;
            font-weight: 700;
            color: #FBBF24;
        }

        .play-balance {
            background: #0F172A;
            padding: 8px 16px;
            border-radius: 40px;
            border: 1px solid #FBBF24;
            color: #FBBF24;
            font-weight: 600;
        }

        .slots-display {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 20px 0;
        }

        .slot-cell {
            background: #0F172A;
            border-radius: 24px;
            padding: 24px 8px;
            font-size: 48px;
            text-align: center;
            border: 2px solid #FBBF24;
        }

        .dice-display {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        .dice-box {
            width: 120px;
            height: 120px;
            background: #0F172A;
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 64px;
            border: 3px solid #FBBF24;
            box-shadow: 0 8px 0 #B45309;
        }

        .choice-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .choice-btn {
            aspect-ratio: 1;
            background: #0F172A;
            border: 2px solid #FBBF24;
            border-radius: 20px;
            font-size: 24px;
            font-weight: 700;
            color: #FBBF24;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 0 #B45309;
        }

        .choice-btn.selected {
            background: #FBBF24;
            color: #0F172A;
            transform: translateY(2px);
            box-shadow: 0 2px 0 #B45309;
        }

        .cases-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 20px 0;
        }

        .case-item {
            aspect-ratio: 1;
            background: #FBBF24;
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid #F59E0B;
            box-shadow: 0 6px 0 #B45309;
            color: #0F172A;
            font-weight: bold;
        }

        .case-item.opened {
            background: #475569;
            border-color: #64748B;
            box-shadow: 0 4px 0 #334155;
        }

        .bet-field {
            width: 100%;
            padding: 16px;
            background: #0F172A;
            border: 2px solid #FBBF24;
            border-radius: 40px;
            font-size: 20px;
            text-align: center;
            font-weight: 600;
            color: #FBBF24;
            margin: 15px 0;
        }

        .game-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .game-btn {
            flex: 1;
            padding: 18px;
            border: none;
            border-radius: 40px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .game-btn.primary {
            background: #FBBF24;
            color: #0F172A;
            box-shadow: 0 6px 0 #B45309;
        }

        .game-btn.secondary {
            background: #475569;
            color: #FBBF24;
            box-shadow: 0 6px 0 #1E293B;
        }

        .game-result {
            margin-top: 16px;
            padding: 16px;
            border-radius: 40px;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
        }

        .win-result {
            background: #FBBF2433;
            color: #FBBF24;
            border: 2px solid #FBBF24;
        }

        .lose-result {
            background: #47556933;
            color: #94A3B8;
            border: 2px solid #64748B;
        }

        .error-msg {
            background: #7F1D1D33;
            color: #FCA5A5;
            padding: 14px;
            border-radius: 40px;
            margin: 10px 0;
            border: 2px solid #DC2626;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- –ó–≤–µ–∑–¥–æ—á–∫–∏ –Ω–∞ —Ñ–æ–Ω–µ -->
    <div class="bg-emoji star-1">‚≠êÔ∏è</div>
    <div class="bg-emoji star-2">üåü</div>
    <div class="bg-emoji star-3">‚ú®</div>
    <div class="bg-emoji star-4">‚≠êÔ∏è</div>
    <div class="bg-emoji star-5">üåü</div>
    <div class="bg-emoji star-6">‚ú®</div>
    <div class="bg-emoji star-7">‚≠êÔ∏è</div>

    <!-- –ú–æ–Ω–µ—Ç–∫–∏ –Ω–∞ —Ñ–æ–Ω–µ -->
    <div class="bg-emoji coin-1">ü™ô</div>
    <div class="bg-emoji coin-2">üí∞</div>
    <div class="bg-emoji coin-3">ü™ô</div>
    <div class="bg-emoji coin-4">üíé</div>
    <div class="bg-emoji coin-5">ü™ô</div>
    <div class="bg-emoji coin-6">üí∞</div>

    <!-- –£—Ç–∫–∏ –Ω–∞ —Ñ–æ–Ω–µ -->
    <div class="duck-bg duck-1"></div>
    <div class="duck-bg duck-2"></div>
    <div class="duck-bg duck-3"></div>

    <div class="app">
        <div class="header">
            <div class="header-top">
                <div class="logo-area">
                    <div class="duck-icon">ü¶Ü</div>
                    <div class="logo-text">DUCK GAMES</div>
                </div>
                <div class="balance-box" id="balanceBox">
                    <span class="star-icon">‚≠êÔ∏è</span>
                    <span class="balance-num" id="balanceDisplay">0</span>
                    <span class="balance-label">STARS</span>
                </div>
            </div>
        </div>

        <div id="mainMenu">
            <div class="global-stats" id="globalStats">
                <div class="global-stat-card">
                    <div class="global-stat-value" id="globalPlays">0</div>
                    <div class="global-stat-label">–í–°–ï–ì–û –ò–ì–†</div>
                </div>
                <div class="global-stat-card">
                    <div class="global-stat-value" id="globalWins">0</div>
                    <div class="global-stat-label">–ü–û–ë–ï–î</div>
                </div>
                <div class="global-stat-card">
                    <div class="global-stat-value" id="globalWinRate">0%</div>
                    <div class="global-stat-label">–í–ò–ù–†–ï–ô–¢</div>
                </div>
                <div class="global-stat-card">
                    <div class="global-stat-value" id="globalBank">0</div>
                    <div class="global-stat-label">–ë–ê–ù–ö‚≠êÔ∏è</div>
                </div>
            </div>

            <div class="menu-title">–í—ã–±–µ—Ä–∏ –∏–≥—Ä—É</div>

            <div class="games-grid">
                <div class="game-card" onclick="showGameMenu('slots')">
                    <div class="card-emoji">üé∞</div>
                    <div class="card-name">–°–ª–æ—Ç—ã</div>
                    <div class="card-stats">
                        <span class="card-stat" id="slotsGlobal">‚ö°Ô∏è 0</span>
                    </div>
                </div>
                <div class="game-card" onclick="showGameMenu('dice')">
                    <div class="card-emoji">üé≤</div>
                    <div class="card-name">–ö–æ—Å—Ç–∏</div>
                    <div class="card-stats">
                        <span class="card-stat" id="diceGlobal">‚ö°Ô∏è 0</span>
                    </div>
                </div>
                <div class="game-card" onclick="showGameMenu('coin')">
                    <div class="card-emoji">ü™ô</div>
                    <div class="card-name">–û—Ä—ë–ª/–†–µ—à–∫–∞</div>
                    <div class="card-stats">
                        <span class="card-stat" id="coinGlobal">‚ö°Ô∏è 0</span>
                    </div>
                </div>
                <div class="game-card" onclick="showGameMenu('cases')">
                    <div class="card-emoji">üéÅ</div>
                    <div class="card-name">–ö–µ–π—Å—ã</div>
                    <div class="card-stats">
                        <span class="card-stat" id="casesGlobal">‚ö°Ô∏è 0</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="gameMenu" class="game-menu"></div>
        <div id="gamePlay" class="game-play-area"></div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        let userId = tg.initDataUnsafe?.user?.id;
        let currentGame = '';
        let selectedChoice = null;
        let userBalance = 0;
        let syncInterval = null;
        let globalStats = {};
        let userStats = {};

        tg.expand();

        // ===== –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –ë–ê–õ–ê–ù–°–ê =====
        async function syncBalance() {
            if (!userId) {
                console.log('–ù–µ—Ç ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                return;
            }
            
            try {
                console.log('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –±–∞–ª–∞–Ω—Å–∞...');
                const response = await fetch(`/api/balance?user_id=${userId}&t=${Date.now()}`);
                const data = await response.json();
                
                console.log('–û—Ç–≤–µ—Ç –æ—Ç –±–æ—Ç–∞:', data);
                
                if (data.success) {
                    const oldBalance = userBalance;
                    userBalance = data.balance;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å –±–∞–ª–∞–Ω—Å–æ–º
                    const balanceDisplay = document.getElementById('balanceDisplay');
                    if (balanceDisplay) balanceDisplay.textContent = userBalance;
                    
                    const playBalance = document.getElementById('playBalance');
                    if (playBalance) playBalance.textContent = userBalance;
                    
                    console.log('–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω:', userBalance);
                    
                    // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
                    if (oldBalance !== userBalance) {
                        const balanceBox = document.getElementById('balanceBox');
                        if (balanceBox) {
                            balanceBox.classList.add('sync');
                            setTimeout(() => balanceBox.classList.remove('sync'), 300);
                        }
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                    if (data.global_stats) {
                        updateGlobalStats(data.global_stats);
                    }
                    if (data.user_stats) {
                        userStats = data.user_stats;
                        console.log('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
                    }
                } else {
                    console.error('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', data.message);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error);
            }
        }

        // –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–ê–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –ü–ï–†–ï–î –ò–ì–†–û–ô
        async function preGameSync() {
            console.log('–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–¥ –∏–≥—Ä–æ–π');
            await syncBalance();
            return userBalance;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function updateGlobalStats(stats) {
            globalStats = stats;
            
            let totalPlays = 0;
            let totalWins = 0;
            let totalBank = 0;
            
            for (let game in stats) {
                totalPlays += stats[game].total_plays || 0;
                totalWins += stats[game].total_wins || 0;
                totalBank += stats[game].total_won || 0;
                
                const elem = document.getElementById(`${game}Global`);
                if (elem) elem.textContent = `‚ö°Ô∏è ${stats[game].total_plays || 0}`;
            }
            
            const winRate = totalPlays > 0 ? Math.round((totalWins / totalPlays) * 100) : 0;
            
            const playsElem = document.getElementById('globalPlays');
            const winsElem = document.getElementById('globalWins');
            const rateElem = document.getElementById('globalWinRate');
            const bankElem = document.getElementById('globalBank');
            
            if (playsElem) playsElem.textContent = totalPlays;
            if (winsElem) winsElem.textContent = totalWins;
            if (rateElem) rateElem.textContent = winRate + '%';
            if (bankElem) bankElem.textContent = totalBank;
        }

        // –ó–∞–ø—É—Å–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        function startBalanceSync() {
            if (syncInterval) clearInterval(syncInterval);
            syncBalance(); // —Å—Ä–∞–∑—É —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º
            syncInterval = setInterval(syncBalance, 2000); // –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
            console.log('–ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞');
        }

        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        function stopBalanceSync() {
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
                console.log('–ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
            }
        }

        // ===== –ù–ê–í–ò–ì–ê–¶–ò–Ø =====
        function showGameMenu(game) {
            currentGame = game;
            
            const titles = {
                slots: { emoji: 'üé∞', name: '–°–ª–æ—Ç—ã' },
                dice: { emoji: 'üé≤', name: '–ö–æ—Å—Ç–∏' },
                coin: { emoji: 'ü™ô', name: '–û—Ä—ë–ª/–†–µ—à–∫–∞' },
                cases: { emoji: 'üéÅ', name: '–ö–µ–π—Å—ã' }
            };

            const stats = userStats[game] || { played: 0, won: 0, total_won: 0, total_bet: 0 };
            const played = stats.played || 0;
            const won = stats.won || 0;
            const winRate = played > 0 ? Math.round((won / played) * 100) : 0;
            const profit = (stats.total_won || 0) - (stats.total_bet || 0);

            const menuHtml = `
                <div class="game-menu-header">
                    <div class="game-menu-emoji">${titles[game].emoji}</div>
                    <div class="game-menu-info">
                        <h2>${titles[game].name}</h2>
                    </div>
                </div>
                
                <div class="game-menu-stats">
                    <div class="game-menu-stat">
                        <div class="stat-value">${played}</div>
                        <div class="stat-label">–ò–ì–†</div>
                    </div>
                    <div class="game-menu-stat">
                        <div class="stat-value">${won}</div>
                        <div class="stat-label">–ü–û–ë–ï–î</div>
                    </div>
                    <div class="game-menu-stat">
                        <div class="stat-value">${winRate}%</div>
                        <div class="stat-label">–í–ò–ù–†–ï–ô–¢</div>
                    </div>
                    <div class="game-menu-stat">
                        <div class="stat-value">${profit >= 0 ? '+' : ''}${profit}</div>
                        <div class="stat-label">–ü–†–û–§–ò–¢</div>
                    </div>
                </div>
                
                <div class="game-menu-buttons">
                    <button class="menu-btn play" onclick="startGame('${game}')">–ò–≥—Ä–∞—Ç—å</button>
                    <button class="menu-btn back" onclick="backToMainMenu()">–ù–∞–∑–∞–¥</button>
                </div>
            `;

            document.getElementById('gameMenu').innerHTML = menuHtml;
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('gameMenu').style.display = 'block';
            document.getElementById('gamePlay').style.display = 'none';
            
            syncBalance();
        }

        function startGame(game) {
            currentGame = game;
            
            const games = {
                slots: `
                    <div class="play-header">
                        <div class="play-title">üé∞ –°–ª–æ—Ç—ã</div>
                        <div class="play-balance" id="playBalance">${userBalance}</div>
                    </div>
                    <div class="slots-display" id="slotsDisplay">
                        <div class="slot-cell">‚ùì</div>
                        <div class="slot-cell">‚ùì</div>
                        <div class="slot-cell">‚ùì</div>
                    </div>
                    <input type="number" class="bet-field" id="betAmount" min="5" max="100" value="10" step="5">
                    <div class="game-result" id="gameResult"></div>
                    <div class="game-buttons">
                        <button class="game-btn primary" onclick="playSlots()">–ö—Ä—É—Ç–∏—Ç—å</button>
                        <button class="game-btn secondary" onclick="backToGameMenu()">–ù–∞–∑–∞–¥</button>
                    </div>
                `,
                dice: `
                    <div class="play-header">
                        <div class="play-title">üé≤ –ö–æ—Å—Ç–∏</div>
                        <div class="play-balance" id="playBalance">${userBalance}</div>
                    </div>
                    <div class="dice-display"><div class="dice-box" id="diceResult">üé≤</div></div>
                    <div class="choice-grid">
                        <button class="choice-btn" onclick="selectChoice(1)">1</button>
                        <button class="choice-btn" onclick="selectChoice(2)">2</button>
                        <button class="choice-btn" onclick="selectChoice(3)">3</button>
                        <button class="choice-btn" onclick="selectChoice(4)">4</button>
                        <button class="choice-btn" onclick="selectChoice(5)">5</button>
                        <button class="choice-btn" onclick="selectChoice(6)">6</button>
                    </div>
                    <input type="number" class="bet-field" id="betAmount" min="1" max="50" value="5" step="1">
                    <div class="game-result" id="gameResult"></div>
                    <div class="game-buttons">
                        <button class="game-btn primary" onclick="playDice()">–ë—Ä–æ—Å–∏—Ç—å</button>
                        <button class="game-btn secondary" onclick="backToGameMenu()">–ù–∞–∑–∞–¥</button>
                    </div>
                `,
                coin: `
                    <div class="play-header">
                        <div class="play-title">ü™ô –û—Ä—ë–ª/–†–µ—à–∫–∞</div>
                        <div class="play-balance" id="playBalance">${userBalance}</div>
                    </div>
                    <div class="dice-display"><div class="dice-box" id="coinResult">ü™ô</div></div>
                    <div class="choice-grid" style="grid-template-columns: repeat(2,1fr);">
                        <button class="choice-btn" onclick="selectChoice('orel')">ü¶Ö</button>
                        <button class="choice-btn" onclick="selectChoice('reshka')">üí∞</button>
                    </div>
                    <input type="number" class="bet-field" id="betAmount" min="1" max="100" value="5" step="1">
                    <div class="game-result" id="gameResult"></div>
                    <div class="game-buttons">
                        <button class="game-btn primary" onclick="playCoin()">–ë—Ä–æ—Å–∏—Ç—å</button>
                        <button class="game-btn secondary" onclick="backToGameMenu()">–ù–∞–∑–∞–¥</button>
                    </div>
                `,
                cases: `
                    <div class="play-header">
                        <div class="play-title">üéÅ –ö–µ–π—Å—ã</div>
                        <div class="play-balance" id="playBalance">${userBalance}</div>
                    </div>
                    <div class="cases-grid" id="casesGrid">
                        <div class="case-item" onclick="openCase(1)">‚ùì</div>
                        <div class="case-item" onclick="openCase(2)">‚ùì</div>
                        <div class="case-item" onclick="openCase(3)">‚ùì</div>
                    </div>
                    <div class="game-result" id="gameResult"></div>
                    <div class="game-buttons">
                        <button class="game-btn secondary" onclick="backToGameMenu()">–ù–∞–∑–∞–¥</button>
                    </div>
                `
            };

            document.getElementById('gamePlay').innerHTML = games[game];
            document.getElementById('gameMenu').style.display = 'none';
            document.getElementById('gamePlay').style.display = 'block';
            
            selectedChoice = null;
            syncBalance(); // –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –ü–†–ò –û–¢–ö–†–´–¢–ò–ò –ò–ì–†–´
        }

        function selectChoice(choice) {
            selectedChoice = choice;
            document.querySelectorAll('.choice-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        function showError(text) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-msg';
            errorDiv.textContent = text;
            
            const container = document.getElementById('gamePlay').style.display === 'block' ? 'gamePlay' : 'gameMenu';
            document.getElementById(container).appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 3000);
        }

        // ===== –ò–ì–†–´ =====
        async function playSlots() {
            await preGameSync(); // –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–ê–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –ü–ï–†–ï–î –ò–ì–†–û–ô
            
            const betInput = document.getElementById('betAmount');
            if (!betInput) return;
            
            const bet = parseInt(betInput.value);
            
            if (bet > userBalance) {
                showError('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–≤—ë–∑–¥!');
                return;
            }
            
            try {
                const response = await fetch('/api/game', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user_id: userId, action: 'slots', bet})
                });
                const result = await response.json();
                
                if (result.success) {
                    userBalance = result.new_balance;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å –±–∞–ª–∞–Ω—Å–æ–º
                    const balanceDisplay = document.getElementById('balanceDisplay');
                    if (balanceDisplay) balanceDisplay.textContent = userBalance;
                    
                    const playBalance = document.getElementById('playBalance');
                    if (playBalance) playBalance.textContent = userBalance;
                    
                    if (result.slots) {
                        document.querySelectorAll('.slot-cell').forEach((el, i) => {
                            if (el) el.textContent = result.slots[i];
                        });
                    }
                    
                    const resultDiv = document.getElementById('gameResult');
                    if (resultDiv) {
                        resultDiv.className = `game-result ${result.win ? 'win-result' : 'lose-result'}`;
                        resultDiv.textContent = result.win ? `üéâ +${result.win_amount} ‚≠êÔ∏è` : '‚ùå –ü—Ä–æ–∏–≥—Ä—ã—à';
                    }
                    
                    // –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –ü–û–°–õ–ï –ò–ì–†–´
                    await syncBalance();
                }
            } catch (error) {
                console.error('Game error:', error);
                showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            }
        }

        async function playDice() {
            if (!selectedChoice) {
                showError('–í—ã–±–µ—Ä–∏ —á–∏—Å–ª–æ!');
                return;
            }
            
            await preGameSync();
            
            const betInput = document.getElementById('betAmount');
            if (!betInput) return;
            
            const bet = parseInt(betInput.value);
            
            if (bet > userBalance) {
                showError('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–≤—ë–∑–¥!');
                return;
            }
            
            try {
                const response = await fetch('/api/game', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user_id: userId, action: 'dice', bet, choice: selectedChoice})
                });
                const result = await response.json();
                
                if (result.success) {
                    userBalance = result.new_balance;
                    
                    const balanceDisplay = document.getElementById('balanceDisplay');
                    if (balanceDisplay) balanceDisplay.textContent = userBalance;
                    
                    const playBalance = document.getElementById('playBalance');
                    if (playBalance) playBalance.textContent = userBalance;
                    
                    const diceResult = document.getElementById('diceResult');
                    if (diceResult && result.dice_value) {
                        diceResult.textContent = result.dice_value;
                    }
                    
                    const resultDiv = document.getElementById('gameResult');
                    if (resultDiv) {
                        resultDiv.className = `game-result ${result.win ? 'win-result' : 'lose-result'}`;
                        resultDiv.textContent = result.win ? `üéâ +${result.win_amount} ‚≠êÔ∏è` : '‚ùå –ü—Ä–æ–∏–≥—Ä—ã—à';
                    }
                    
                    await syncBalance();
                }
            } catch (error) {
                console.error('Game error:', error);
                showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            }
        }

        async function playCoin() {
            if (!selectedChoice) {
                showError('–í—ã–±–µ—Ä–∏ —Å—Ç–æ—Ä–æ–Ω—É!');
                return;
            }
            
            await preGameSync();
            
            const betInput = document.getElementById('betAmount');
            if (!betInput) return;
            
            const bet = parseInt(betInput.value);
            
            if (bet > userBalance) {
                showError('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–≤—ë–∑–¥!');
                return;
            }
            
            try {
                const response = await fetch('/api/game', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user_id: userId, action: 'coin', bet, choice: selectedChoice})
                });
                const result = await response.json();
                
                if (result.success) {
                    userBalance = result.new_balance;
                    
                    const balanceDisplay = document.getElementById('balanceDisplay');
                    if (balanceDisplay) balanceDisplay.textContent = userBalance;
                    
                    const playBalance = document.getElementById('playBalance');
                    if (playBalance) playBalance.textContent = userBalance;
                    
                    const coinResult = document.getElementById('coinResult');
                    if (coinResult && result.coin_value) {
                        coinResult.textContent = result.coin_value === 'orel' ? 'ü¶Ö' : 'üí∞';
                    }
                    
                    const resultDiv = document.getElementById('gameResult');
                    if (resultDiv) {
                        resultDiv.className = `game-result ${result.win ? 'win-result' : 'lose-result'}`;
                        resultDiv.textContent = result.win ? `üéâ +${result.win_amount} ‚≠êÔ∏è` : '‚ùå –ü—Ä–æ–∏–≥—Ä—ã—à';
                    }
                    
                    await syncBalance();
                }
            } catch (error) {
                console.error('Game error:', error);
                showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            }
        }

        async function openCase(caseNum) {
            await preGameSync();
            
            if (userBalance < 10) {
                showError('–ù—É–∂–Ω–æ 10 ‚≠êÔ∏è');
                return;
            }
            
            try {
                const response = await fetch('/api/game', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user_id: userId, action: 'case', case: caseNum})
                });
                const result = await response.json();
                
                if (result.success) {
                    userBalance = result.new_balance;
                    
                    const balanceDisplay = document.getElementById('balanceDisplay');
                    if (balanceDisplay) balanceDisplay.textContent = userBalance;
                    
                    const playBalance = document.getElementById('playBalance');
                    if (playBalance) playBalance.textContent = userBalance;
                    
                    const caseEl = event.target;
                    if (caseEl) {
                        caseEl.textContent = result.prize;
                        caseEl.classList.add('opened');
                        caseEl.onclick = null;
                    }
                    
                    const resultDiv = document.getElementById('gameResult');
                    if (resultDiv) {
                        resultDiv.className = 'game-result win-result';
                        resultDiv.textContent = `üéâ +${result.prize} ‚≠êÔ∏è`;
                    }
                    
                    await syncBalance();
                }
            } catch (error) {
                console.error('Game error:', error);
                showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            }
        }

        function backToMainMenu() {
            document.getElementById('mainMenu').style.display = 'block';
            document.getElementById('gameMenu').style.display = 'none';
            document.getElementById('gamePlay').style.display = 'none';
            syncBalance();
        }

        function backToGameMenu() {
            if (currentGame) showGameMenu(currentGame);
            else backToMainMenu();
        }

        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø - –∑–∞–ø—É—Å–∫–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —Å—Ä–∞–∑—É
        document.addEventListener('DOMContentLoaded', function() {
            console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –∑–∞–ø—É—Å–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏...');
            startBalanceSync();
        });

        // –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
        window.addEventListener('beforeunload', function() {
            stopBalanceSync();
        });
    </script>
</body>
</html>
