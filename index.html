<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ü¶Ü DUCK GAMES</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –°–¢–ò–õ–ò (—Ç–∞–∫–∏–µ –∂–µ –∫–∞–∫ –±—ã–ª–∏) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background: linear-gradient(145deg, #87CEEB 0%, #B0E0E6 100%);
            min-height: 100vh;
            padding: 16px;
            position: relative;
            overflow-x: hidden;
        }

        .bg-emoji {
            position: fixed;
            pointer-events: none;
            z-index: 0;
            font-size: 24px;
            opacity: 0.15;
            animation: float 15s infinite linear;
            user-select: none;
        }

        @keyframes float {
            0% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-20px) rotate(5deg); }
            75% { transform: translateY(20px) rotate(-5deg); }
            100% { transform: translateY(0) rotate(0deg); }
        }

        .star-1 { top: 2%; left: 3%; animation-delay: 0s; font-size: 28px; }
        .star-2 { top: 10%; right: 5%; animation-delay: 1s; font-size: 32px; }
        .star-3 { top: 25%; left: 8%; animation-delay: 2s; font-size: 24px; }
        .star-4 { top: 35%; right: 12%; animation-delay: 3s; font-size: 36px; }
        .star-5 { top: 45%; left: 15%; animation-delay: 4s; font-size: 30px; }
        .star-6 { top: 55%; right: 8%; animation-delay: 5s; font-size: 26px; }
        .star-7 { top: 65%; left: 5%; animation-delay: 6s; font-size: 34px; }
        .star-8 { top: 75%; right: 18%; animation-delay: 7s; font-size: 28px; }
        .star-9 { top: 85%; left: 12%; animation-delay: 8s; font-size: 32px; }
        .star-10 { top: 95%; right: 5%; animation-delay: 9s; font-size: 24px; }
        
        .coin-1 { top: 5%; left: 20%; animation-delay: 0.5s; font-size: 32px; }
        .coin-2 { top: 15%; right: 25%; animation-delay: 1.5s; font-size: 28px; }
        .coin-3 { top: 30%; left: 40%; animation-delay: 2.5s; font-size: 36px; }
        .coin-4 { top: 40%; right: 35%; animation-delay: 3.5s; font-size: 30px; }
        .coin-5 { top: 50%; left: 60%; animation-delay: 4.5s; font-size: 26px; }
        .coin-6 { top: 60%; right: 45%; animation-delay: 5.5s; font-size: 34px; }
        .coin-7 { top: 70%; left: 75%; animation-delay: 6.5s; font-size: 28px; }
        .coin-8 { top: 80%; right: 55%; animation-delay: 7.5s; font-size: 32px; }
        .coin-9 { top: 90%; left: 85%; animation-delay: 8.5s; font-size: 24px; }

        .app {
            max-width: 500px;
            margin: 0 auto;
            position: relative;
            z-index: 10;
        }

        .header {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(15px);
            border-radius: 28px;
            padding: 16px 20px;
            margin-bottom: 20px;
            border: 2px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 0 rgba(0, 0, 0, 0.1);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .duck-icon {
            width: 44px;
            height: 44px;
            background: #1E3A8A;
            border-radius: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 0 #0F2A5A;
        }

        .logo-text {
            font-size: 22px;
            font-weight: 700;
            color: #1E3A8A;
            text-shadow: 2px 2px 0 rgba(255, 255, 255, 0.5);
        }

        .balance-box {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(5px);
            border-radius: 40px;
            padding: 8px 16px;
            border: 2px solid #1E3A8A;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
        }

        .balance-box.syncing {
            border-color: #4CAF50;
            box-shadow: 0 0 20px #4CAF50;
            transform: scale(1.02);
        }

        .balance-box.flash {
            animation: flash 0.3s ease;
        }

        @keyframes flash {
            0% { transform: scale(1); background: rgba(255, 255, 255, 0.4); }
            50% { transform: scale(1.1); background: rgba(76, 175, 80, 0.3); }
            100% { transform: scale(1); background: rgba(255, 255, 255, 0.4); }
        }

        .star-icon {
            font-size: 20px;
            color: #1E3A8A;
        }

        .balance-num {
            font-size: 22px;
            font-weight: 700;
            color: #1E3A8A;
        }

        .balance-label {
            font-size: 12px;
            color: #1E3A8A;
            opacity: 0.8;
        }

        .global-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 24px;
        }

        .global-stat-card {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(8px);
            border-radius: 20px;
            padding: 12px 4px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 0 rgba(0, 0, 0, 0.05);
        }

        .global-stat-value {
            font-size: 18px;
            font-weight: 700;
            color: #1E3A8A;
        }

        .global-stat-label {
            font-size: 10px;
            color: #1E3A8A;
            opacity: 0.8;
            margin-top: 4px;
        }

        .menu-title {
            font-size: 18px;
            color: #1E3A8A;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .menu-title::before {
            content: 'ü¶Ü';
            font-size: 22px;
        }

        .games-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .game-card {
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            padding: 24px 16px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
            box-shadow: 0 6px 0 rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .game-card:hover {
            border-color: #1E3A8A;
            transform: translateY(-4px);
            box-shadow: 0 10px 0 rgba(0, 0, 0, 0.1);
        }

        .card-emoji {
            font-size: 56px;
            margin-bottom: 12px;
            filter: drop-shadow(0 4px 4px rgba(0,0,0,0.1));
        }

        .card-name {
            font-size: 20px;
            font-weight: 700;
            color: #1E3A8A;
            margin-bottom: 4px;
        }

        .card-stats {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 12px;
            font-size: 12px;
        }

        .card-stat {
            background: rgba(255, 255, 255, 0.5);
            padding: 4px 10px;
            border-radius: 20px;
            color: #1E3A8A;
            font-weight: 600;
        }

        .game-menu {
            display: none;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(15px);
            border-radius: 28px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 0 rgba(0, 0, 0, 0.1);
        }

        .game-menu-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.5);
        }

        .game-menu-emoji {
            font-size: 48px;
            background: rgba(255, 255, 255, 0.4);
            width: 80px;
            height: 80px;
            border-radius: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #1E3A8A;
        }

        .game-menu-info h2 {
            font-size: 28px;
            font-weight: 700;
            color: #1E3A8A;
        }

        .game-menu-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .game-menu-stat {
            background: rgba(255, 255, 255, 0.4);
            border-radius: 16px;
            padding: 12px 4px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: #1E3A8A;
        }

        .stat-label {
            font-size: 10px;
            color: #1E3A8A;
            opacity: 0.8;
        }

        .game-menu-buttons {
            display: flex;
            gap: 12px;
        }

        .menu-btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 40px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .menu-btn.play {
            background: #1E3A8A;
            color: white;
            box-shadow: 0 6px 0 #0F2A5A;
        }

        .menu-btn.play:hover {
            transform: translateY(-3px);
            box-shadow: 0 9px 0 #0F2A5A;
        }

        .menu-btn.back {
            background: rgba(255, 255, 255, 0.5);
            color: #1E3A8A;
            box-shadow: 0 6px 0 rgba(0, 0, 0, 0.1);
        }

        .game-play-area {
            display: none;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(15px);
            border-radius: 28px;
            padding: 24px;
            border: 2px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 0 rgba(0, 0, 0, 0.1);
        }

        .play-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .play-title {
            font-size: 24px;
            font-weight: 700;
            color: #1E3A8A;
        }

        .play-balance {
            background: rgba(255, 255, 255, 0.5);
            padding: 8px 16px;
            border-radius: 40px;
            border: 1px solid #1E3A8A;
            color: #1E3A8A;
            font-weight: 600;
            transition: all 0.3s;
        }

        .play-balance.syncing {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.2);
        }

        .slots-display {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 20px 0;
        }

        .slot-cell {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 24px;
            padding: 24px 8px;
            font-size: 48px;
            text-align: center;
            border: 2px solid #1E3A8A;
            box-shadow: inset 0 -4px 0 #0F2A5A;
        }

        .slot-cell.spin {
            animation: spin 0.5s ease;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(10deg); }
            75% { transform: rotate(-10deg); }
            100% { transform: rotate(0deg); }
        }

        .dice-display {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        .dice-box {
            width: 120px;
            height: 120px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 64px;
            border: 3px solid #1E3A8A;
            box-shadow: 0 8px 0 #0F2A5A;
        }

        .dice-box.roll {
            animation: roll 0.5s ease;
        }

        @keyframes roll {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .choice-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .choice-btn {
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.5);
            border: 2px solid #1E3A8A;
            border-radius: 20px;
            font-size: 24px;
            font-weight: 700;
            color: #1E3A8A;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 0 #0F2A5A;
        }

        .choice-btn.selected {
            background: #1E3A8A;
            color: white;
            transform: translateY(2px);
            box-shadow: 0 2px 0 #0F2A5A;
        }

        .choice-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: translateY(2px);
            box-shadow: 0 2px 0 #0F2A5A;
        }

        .cases-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 20px 0;
        }

        .case-item {
            aspect-ratio: 1;
            background: #1E3A8A;
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid #0F2A5A;
            box-shadow: 0 6px 0 #0A1F3F;
            color: white;
            font-weight: bold;
        }

        .case-item.opened {
            background: rgba(255, 255, 255, 0.5);
            border-color: #1E3A8A;
            box-shadow: 0 4px 0 #0F2A5A;
            color: #1E3A8A;
        }

        .case-item:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .bet-field {
            width: 100%;
            padding: 16px;
            background: rgba(255, 255, 255, 0.5);
            border: 2px solid #1E3A8A;
            border-radius: 40px;
            font-size: 20px;
            text-align: center;
            font-weight: 600;
            color: #1E3A8A;
            margin: 15px 0;
        }

        .bet-field:disabled {
            opacity: 0.5;
        }

        .game-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .game-btn {
            flex: 1;
            padding: 18px;
            border: none;
            border-radius: 40px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .game-btn.primary {
            background: #1E3A8A;
            color: white;
            box-shadow: 0 6px 0 #0F2A5A;
        }

        .game-btn.primary:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 9px 0 #0F2A5A;
        }

        .game-btn.secondary {
            background: rgba(255, 255, 255, 0.5);
            color: #1E3A8A;
            box-shadow: 0 6px 0 rgba(0, 0, 0, 0.1);
        }

        .game-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: translateY(2px);
            box-shadow: 0 4px 0 rgba(0, 0, 0, 0.1);
        }

        .game-result {
            margin-top: 16px;
            padding: 16px;
            border-radius: 40px;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            animation: resultPop 0.3s;
        }

        @keyframes resultPop {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .win-result {
            background: rgba(76, 175, 80, 0.2);
            color: #2E7D32;
            border: 2px solid #4CAF50;
        }

        .lose-result {
            background: rgba(244, 67, 54, 0.2);
            color: #C62828;
            border: 2px solid #F44336;
        }

        .error-msg {
            background: rgba(244, 67, 54, 0.2);
            color: #C62828;
            padding: 14px;
            border-radius: 40px;
            margin: 10px 0;
            border: 2px solid #F44336;
            text-align: center;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #1E3A8A;
            font-size: 16px;
        }

        .sync-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4CAF50;
            margin-left: 8px;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- –§–æ–Ω–æ–≤—ã–µ —ç–º–æ–¥–∑–∏ -->
    <div class="bg-emoji star-1">‚≠êÔ∏è</div>
    <div class="bg-emoji star-2">üåü</div>
    <div class="bg-emoji star-3">‚ú®</div>
    <div class="bg-emoji star-4">‚≠êÔ∏è</div>
    <div class="bg-emoji star-5">üåü</div>
    <div class="bg-emoji star-6">‚ú®</div>
    <div class="bg-emoji star-7">‚≠êÔ∏è</div>
    <div class="bg-emoji star-8">üåü</div>
    <div class="bg-emoji star-9">‚ú®</div>
    <div class="bg-emoji star-10">‚≠êÔ∏è</div>
    <div class="bg-emoji coin-1">ü™ô</div>
    <div class="bg-emoji coin-2">üí∞</div>
    <div class="bg-emoji coin-3">ü™ô</div>
    <div class="bg-emoji coin-4">üíé</div>
    <div class="bg-emoji coin-5">ü™ô</div>
    <div class="bg-emoji coin-6">üí∞</div>
    <div class="bg-emoji coin-7">ü™ô</div>
    <div class="bg-emoji coin-8">üíé</div>
    <div class="bg-emoji coin-9">üí∞</div>

    <div class="app">
        <div class="header">
            <div class="header-top">
                <div class="logo-area">
                    <div class="duck-icon">ü¶Ü</div>
                    <div class="logo-text">DUCK GAMES</div>
                </div>
                <div class="balance-box" id="balanceBox">
                    <span class="star-icon">‚≠êÔ∏è</span>
                    <span class="balance-num" id="balanceDisplay">0</span>
                    <span class="balance-label">STARS</span>
                    <span class="sync-indicator" id="syncIndicator" style="display: none;"></span>
                </div>
            </div>
        </div>

        <div id="mainMenu">
            <div class="global-stats" id="globalStats">
                <div class="global-stat-card">
                    <div class="global-stat-value" id="globalPlays">0</div>
                    <div class="global-stat-label">–í–°–ï–ì–û –ò–ì–†</div>
                </div>
                <div class="global-stat-card">
                    <div class="global-stat-value" id="globalWins">0</div>
                    <div class="global-stat-label">–ü–û–ë–ï–î</div>
                </div>
                <div class="global-stat-card">
                    <div class="global-stat-value" id="globalWinRate">0%</div>
                    <div class="global-stat-label">–í–ò–ù–†–ï–ô–¢</div>
                </div>
                <div class="global-stat-card">
                    <div class="global-stat-value" id="globalBank">0</div>
                    <div class="global-stat-label">–ë–ê–ù–ö‚≠êÔ∏è</div>
                </div>
            </div>

            <div class="menu-title">–í—ã–±–µ—Ä–∏ –∏–≥—Ä—É</div>

            <div class="games-grid">
                <div class="game-card" onclick="showGameMenu('slots')">
                    <div class="card-emoji">üé∞</div>
                    <div class="card-name">–°–ª–æ—Ç—ã</div>
                    <div class="card-stats">
                        <span class="card-stat" id="slotsGlobal">‚ö°Ô∏è 0</span>
                    </div>
                </div>
                <div class="game-card" onclick="showGameMenu('dice')">
                    <div class="card-emoji">üé≤</div>
                    <div class="card-name">–ö–æ—Å—Ç–∏</div>
                    <div class="card-stats">
                        <span class="card-stat" id="diceGlobal">‚ö°Ô∏è 0</span>
                    </div>
                </div>
                <div class="game-card" onclick="showGameMenu('coin')">
                    <div class="card-emoji">ü™ô</div>
                    <div class="card-name">–û—Ä—ë–ª/–†–µ—à–∫–∞</div>
                    <div class="card-stats">
                        <span class="card-stat" id="coinGlobal">‚ö°Ô∏è 0</span>
                    </div>
                </div>
                <div class="game-card" onclick="showGameMenu('cases')">
                    <div class="card-emoji">üéÅ</div>
                    <div class="card-name">–ö–µ–π—Å—ã</div>
                    <div class="card-stats">
                        <span class="card-stat" id="casesGlobal">‚ö°Ô∏è 0</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="gameMenu" class="game-menu"></div>
        <div id="gamePlay" class="game-play-area"></div>
    </div>

    <script>
        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø TELEGRAM ==========
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        
        // ========== –ü–û–õ–£–ß–ê–ï–ú USER ID –ò–ó URL ==========
        const urlParams = new URLSearchParams(window.location.search);
        const urlUserId = urlParams.get('user_id');
        
        // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ Telegram, –µ—Å–ª–∏ –Ω–µ—Ç - –±–µ—Ä–µ–º –∏–∑ URL
        const tgUserId = tg.initDataUnsafe?.user?.id;
        const userId = tgUserId || urlUserId || null;
        
        console.log('üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê:');
        console.log('üì± Telegram WebApp –≤–µ—Ä—Å–∏—è:', tg.version);
        console.log('üë§ User ID –∏–∑ Telegram:', tgUserId);
        console.log('üîó User ID –∏–∑ URL:', urlUserId);
        console.log('‚úÖ –ò–¢–û–ì–û–í–´–ô User ID:', userId);
        
        // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
        const API_URL = 'https://star-bot-telegram-production.up.railway.app/api/game';
        
        // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
        let currentGame = '';
        let selectedChoice = null;
        let userBalance = 0;
        let globalStats = {};
        let userStats = {};
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
        let isSyncing = false;
        let lastSyncTime = 0;
        let pendingGameAction = false;
        
        // ========== –û–¢–ü–†–ê–í–ö–ê –ó–ê–ü–†–û–°–û–í –ö API ==========
        async function sendToBot(action, data = {}) {
            console.log(`üì§ –û—Ç–ø—Ä–∞–≤–∫–∞: ${action}`, data);
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π User ID - –∏—Å–ø–æ–ª—å–∑—É–µ–º API
            if (userId) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            user_id: parseInt(userId),
                            action: action,
                            ...data
                        })
                    });

                    console.log(`üì• –°—Ç–∞—Ç—É—Å: ${response.status}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const result = await response.json();
                    console.log(`‚úÖ –û—Ç–≤–µ—Ç:`, result);
                    return result;
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ API:', error);
                    // –ï—Å–ª–∏ API –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                    return { 
                        success: false, 
                        message: '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º' 
                    };
                }
            } else {
                // –ù–µ—Ç User ID - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                console.error('‚ùå –ù–ï–¢ USER ID!');
                showError('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ó–∞–∫—Ä–æ–π—Ç–µ –∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –∏–≥—Ä—É –∑–∞–Ω–æ–≤–æ.');
                return { success: false, message: 'No user ID' };
            }
        }
        
        // ========== –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –ë–ê–õ–ê–ù–°–ê ==========
        async function syncBalance(force = false, showIndicator = true) {
            const now = Date.now();
            
            if (!force && now - lastSyncTime < 1000) {
                return false;
            }
            
            if (isSyncing) {
                return false;
            }
            
            isSyncing = true;
            lastSyncTime = now;
            
            if (showIndicator) {
                document.getElementById('syncIndicator').style.display = 'inline-block';
                document.getElementById('balanceBox').classList.add('syncing');
            }
            
            try {
                const result = await sendToBot('get_balance');
                
                if (result?.success) {
                    const oldBalance = userBalance;
                    userBalance = result.balance;
                    
                    updateAllBalances();
                    
                    if (oldBalance !== userBalance) {
                        flashBalance();
                    }
                    
                    if (result.global_stats) {
                        updateGlobalStats(result.global_stats);
                    }
                    if (result.user_stats) {
                        userStats = result.user_stats;
                    }
                    
                    console.log(`‚úÖ –ë–∞–ª–∞–Ω—Å: ${userBalance} ‚≠êÔ∏è`);
                    return true;
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error);
            } finally {
                isSyncing = false;
                
                if (showIndicator) {
                    setTimeout(() => {
                        document.getElementById('syncIndicator').style.display = 'none';
                        document.getElementById('balanceBox').classList.remove('syncing');
                    }, 500);
                }
            }
            
            return false;
        }
        
        function updateAllBalances() {
            document.getElementById('balanceDisplay').textContent = userBalance;
            
            const playBalance = document.getElementById('playBalance');
            if (playBalance) {
                playBalance.textContent = userBalance;
            }
        }
        
        function flashBalance() {
            const balanceBox = document.getElementById('balanceBox');
            balanceBox.classList.add('flash');
            setTimeout(() => balanceBox.classList.remove('flash'), 300);
        }
        
        function updateGlobalStats(stats) {
            globalStats = stats;
            let totalPlays = 0, totalWins = 0, totalBank = 0;
            
            for (let game in stats) {
                totalPlays += stats[game].total_plays || 0;
                totalWins += stats[game].total_wins || 0;
                totalBank += stats[game].total_won || 0;
                
                const elem = document.getElementById(`${game}Global`);
                if (elem) elem.textContent = `‚ö°Ô∏è ${stats[game].total_plays || 0}`;
            }
            
            const winRate = totalPlays > 0 ? Math.round((totalWins / totalPlays) * 100) : 0;
            document.getElementById('globalPlays').textContent = totalPlays;
            document.getElementById('globalWins').textContent = totalWins;
            document.getElementById('globalWinRate').textContent = winRate + '%';
            document.getElementById('globalBank').textContent = totalBank;
        }
        
        // ========== –ò–ì–†–û–í–´–ï –î–ï–ô–°–¢–í–ò–Ø ==========
        async function playGame(action, data = {}) {
            if (pendingGameAction) {
                showError('–ü–æ–¥–æ–∂–¥–∏—Ç–µ, –∏–≥—Ä–∞ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–∞');
                return null;
            }
            
            pendingGameAction = true;
            disableGameButtons(true);
            
            try {
                const result = await sendToBot(action, data);
                
                if (result?.success) {
                    if (result.new_balance !== undefined) {
                        userBalance = result.new_balance;
                        updateAllBalances();
                        flashBalance();
                    }
                    
                    setTimeout(() => syncBalance(true, false), 500);
                }
                
                return result;
            } finally {
                pendingGameAction = false;
                disableGameButtons(false);
            }
        }
        
        function disableGameButtons(disable) {
            const buttons = document.querySelectorAll('.game-btn.primary, .choice-btn, .case-item');
            buttons.forEach(btn => {
                if (disable) {
                    btn.disabled = true;
                } else {
                    btn.disabled = false;
                }
            });
            
            const betField = document.getElementById('betAmount');
            if (betField) betField.disabled = disable;
        }
        
        // ========== –ò–ì–†–´ ==========
        async function playSlots() {
            const bet = parseInt(document.getElementById('betAmount').value);
            
            if (isNaN(bet) || bet < 5) {
                return showError('–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞ 5 ‚≠êÔ∏è');
            }
            
            if (bet > userBalance) {
                return showError('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–≤—ë–∑–¥!');
            }
            
            document.querySelectorAll('.slot-cell').forEach(cell => {
                cell.classList.add('spin');
            });
            
            const result = await playGame('slots', { bet });
            
            document.querySelectorAll('.slot-cell').forEach(cell => {
                setTimeout(() => cell.classList.remove('spin'), 500);
            });
            
            if (result?.success) {
                if (result.slots) {
                    document.querySelectorAll('.slot-cell').forEach((el, i) => {
                        el.textContent = result.slots[i];
                    });
                }
                
                const resultDiv = document.getElementById('gameResult');
                resultDiv.className = `game-result ${result.win ? 'win-result' : 'lose-result'}`;
                resultDiv.textContent = result.win ? `üéâ +${result.win_amount} ‚≠êÔ∏è` : '‚ùå –ü—Ä–æ–∏–≥—Ä—ã—à';
            }
        }
        
        async function playDice() {
            if (!selectedChoice) {
                return showError('–í—ã–±–µ—Ä–∏ —á–∏—Å–ª–æ!');
            }
            
            const bet = parseInt(document.getElementById('betAmount').value);
            
            if (isNaN(bet) || bet < 1) {
                return showError('–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞ 1 ‚≠êÔ∏è');
            }
            
            if (bet > userBalance) {
                return showError('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–≤—ë–∑–¥!');
            }
            
            const diceBox = document.getElementById('diceResult');
            diceBox.classList.add('roll');
            
            const result = await playGame('dice', { bet, choice: selectedChoice });
            
            setTimeout(() => diceBox.classList.remove('roll'), 500);
            
            if (result?.success) {
                diceBox.textContent = result.dice_value;
                
                const resultDiv = document.getElementById('gameResult');
                resultDiv.className = `game-result ${result.win ? 'win-result' : 'lose-result'}`;
                resultDiv.textContent = result.win ? `üéâ +${result.win_amount} ‚≠êÔ∏è` : '‚ùå –ü—Ä–æ–∏–≥—Ä—ã—à';
            }
        }
        
        async function playCoin() {
            if (!selectedChoice) {
                return showError('–í—ã–±–µ—Ä–∏ —Å—Ç–æ—Ä–æ–Ω—É!');
            }
            
            const bet = parseInt(document.getElementById('betAmount').value);
            
            if (isNaN(bet) || bet < 1) {
                return showError('–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞ 1 ‚≠êÔ∏è');
            }
            
            if (bet > userBalance) {
                return showError('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–≤—ë–∑–¥!');
            }
            
            const coinBox = document.getElementById('coinResult');
            coinBox.classList.add('roll');
            
            const result = await playGame('coin', { bet, choice: selectedChoice });
            
            setTimeout(() => coinBox.classList.remove('roll'), 500);
            
            if (result?.success) {
                coinBox.textContent = result.coin_value === 'orel' ? 'ü¶Ö' : 'üí∞';
                
                const resultDiv = document.getElementById('gameResult');
                resultDiv.className = `game-result ${result.win ? 'win-result' : 'lose-result'}`;
                resultDiv.textContent = result.win ? `üéâ +${result.win_amount} ‚≠êÔ∏è` : '‚ùå –ü—Ä–æ–∏–≥—Ä—ã—à';
            }
        }
        
        async function openCase(caseNum) {
            if (userBalance < 10) {
                return showError('–ù—É–∂–Ω–æ 10 ‚≠êÔ∏è');
            }
            
            const caseElement = event.target;
            caseElement.style.transform = 'scale(0.9)';
            
            const result = await playGame('case', { case: caseNum });
            
            caseElement.style.transform = 'scale(1)';
            
            if (result?.success) {
                caseElement.textContent = result.prize;
                caseElement.classList.add('opened');
                caseElement.onclick = null;
                
                const resultDiv = document.getElementById('gameResult');
                resultDiv.className = 'game-result win-result';
                resultDiv.textContent = `üéâ +${result.prize} ‚≠êÔ∏è`;
            }
        }
        
        function showError(text) {
            const gamePlay = document.getElementById('gamePlay');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-msg';
            errorDiv.textContent = text;
            gamePlay.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 3000);
        }
        
        function selectChoice(choice) {
            selectedChoice = choice;
            document.querySelectorAll('.choice-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
        }
        
        function showGameMenu(game) {
            currentGame = game;
            const titles = { slots: 'üé∞', dice: 'üé≤', coin: 'ü™ô', cases: 'üéÅ' };
            const stats = userStats[game] || { played: 0, won: 0, total_won: 0, total_bet: 0 };
            const played = stats.played || 0;
            const won = stats.won || 0;
            const winRate = played > 0 ? Math.round((won / played) * 100) : 0;
            const profit = (stats.total_won || 0) - (stats.total_bet || 0);

            document.getElementById('gameMenu').innerHTML = `
                <div class="game-menu-header">
                    <div class="game-menu-emoji">${titles[game]}</div>
                    <div class="game-menu-info"><h2>${game}</h2></div>
                </div>
                <div class="game-menu-stats">
                    <div class="game-menu-stat"><div class="stat-value">${played}</div><div class="stat-label">–ò–ì–†</div></div>
                    <div class="game-menu-stat"><div class="stat-value">${won}</div><div class="stat-label">–ü–û–ë–ï–î</div></div>
                    <div class="game-menu-stat"><div class="stat-value">${winRate}%</div><div class="stat-label">–í–ò–ù–†–ï–ô–¢</div></div>
                    <div class="game-menu-stat"><div class="stat-value">${profit >= 0 ? '+' : ''}${profit}</div><div class="stat-label">–ü–†–û–§–ò–¢</div></div>
                </div>
                <div class="game-menu-buttons">
                    <button class="menu-btn play" onclick="startGame('${game}')">–ò–≥—Ä–∞—Ç—å</button>
                    <button class="menu-btn back" onclick="backToMainMenu()">–ù–∞–∑–∞–¥</button>
                </div>
            `;
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('gameMenu').style.display = 'block';
            document.getElementById('gamePlay').style.display = 'none';
            
            syncBalance(true);
        }
        
        function startGame(game) {
            currentGame = game;
            selectedChoice = null;
            
            const templates = {
                slots: `
                    <div class="play-header">
                        <div class="play-title">üé∞ –°–ª–æ—Ç—ã</div>
                        <div class="play-balance" id="playBalance">${userBalance}</div>
                    </div>
                    <div class="slots-display" id="slotsDisplay">
                        <div class="slot-cell">‚ùì</div><div class="slot-cell">‚ùì</div><div class="slot-cell">‚ùì</div>
                    </div>
                    <input type="number" class="bet-field" id="betAmount" min="5" max="100" value="10" step="5">
                    <div class="game-result" id="gameResult"></div>
                    <div class="game-buttons">
                        <button class="game-btn primary" onclick="playSlots()">–ö—Ä—É—Ç–∏—Ç—å</button>
                        <button class="game-btn secondary" onclick="backToGameMenu()">–ù–∞–∑–∞–¥</button>
                    </div>
                `,
                dice: `
                    <div class="play-header">
                        <div class="play-title">üé≤ –ö–æ—Å—Ç–∏</div>
                        <div class="play-balance" id="playBalance">${userBalance}</div>
                    </div>
                    <div class="dice-display"><div class="dice-box" id="diceResult">üé≤</div></div>
                    <div class="choice-grid">
                        <button class="choice-btn" onclick="selectChoice(1)">1</button>
                        <button class="choice-btn" onclick="selectChoice(2)">2</button>
                        <button class="choice-btn" onclick="selectChoice(3)">3</button>
                        <button class="choice-btn" onclick="selectChoice(4)">4</button>
                        <button class="choice-btn" onclick="selectChoice(5)">5</button>
                        <button class="choice-btn" onclick="selectChoice(6)">6</button>
                    </div>
                    <input type="number" class="bet-field" id="betAmount" min="1" max="50" value="5" step="1">
                    <div class="game-result" id="gameResult"></div>
                    <div class="game-buttons">
                        <button class="game-btn primary" onclick="playDice()">–ë—Ä–æ—Å–∏—Ç—å</button>
                        <button class="game-btn secondary" onclick="backToGameMenu()">–ù–∞–∑–∞–¥</button>
                    </div>
                `,
                coin: `
                    <div class="play-header">
                        <div class="play-title">ü™ô –û—Ä—ë–ª/–†–µ—à–∫–∞</div>
                        <div class="play-balance" id="playBalance">${userBalance}</div>
                    </div>
                    <div class="dice-display"><div class="dice-box" id="coinResult">ü™ô</div></div>
                    <div class="choice-grid" style="grid-template-columns: repeat(2,1fr);">
                        <button class="choice-btn" onclick="selectChoice('orel')">ü¶Ö</button>
                        <button class="choice-btn" onclick="selectChoice('reshka')">üí∞</button>
                    </div>
                    <input type="number" class="bet-field" id="betAmount" min="1" max="100" value="5" step="1">
                    <div class="game-result" id="gameResult"></div>
                    <div class="game-buttons">
                        <button class="game-btn primary" onclick="playCoin()">–ë—Ä–æ—Å–∏—Ç—å</button>
                        <button class="game-btn secondary" onclick="backToGameMenu()">–ù–∞–∑–∞–¥</button>
                    </div>
                `,
                cases: `
                    <div class="play-header">
                        <div class="play-title">üéÅ –ö–µ–π—Å—ã</div>
                        <div class="play-balance" id="playBalance">${userBalance}</div>
                    </div>
                    <div class="cases-grid" id="casesGrid">
                        <div class="case-item" onclick="openCase(1)">‚ùì</div>
                        <div class="case-item" onclick="openCase(2)">‚ùì</div>
                        <div class="case-item" onclick="openCase(3)">‚ùì</div>
                    </div>
                    <div class="game-result" id="gameResult"></div>
                    <div class="game-buttons">
                        <button class="game-btn secondary" onclick="backToGameMenu()">–ù–∞–∑–∞–¥</button>
                    </div>
                `
            };
            
            document.getElementById('gamePlay').innerHTML = templates[game];
            document.getElementById('gameMenu').style.display = 'none';
            document.getElementById('gamePlay').style.display = 'block';
            
            syncBalance(true);
        }
        
        function backToMainMenu() {
            document.getElementById('mainMenu').style.display = 'block';
            document.getElementById('gameMenu').style.display = 'none';
            document.getElementById('gamePlay').style.display = 'none';
            syncBalance(true);
        }
        
        function backToGameMenu() {
            if (currentGame) {
                showGameMenu(currentGame);
            } else {
                backToMainMenu();
            }
        }
        
        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        async function init() {
            console.log('üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...');
            
            if (!userId) {
                console.error('‚ùå –ù–ï–¢ USER ID!');
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                const errorDiv = document.createElement('div');
                errorDiv.style.background = '#f44336';
                errorDiv.style.color = 'white';
                errorDiv.style.padding = '15px';
                errorDiv.style.borderRadius = '10px';
                errorDiv.style.margin = '10px 0';
                errorDiv.style.textAlign = 'center';
                errorDiv.innerHTML = '‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏<br>–ó–∞–∫—Ä–æ–π—Ç–µ –∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –∏–≥—Ä—É –∑–∞–Ω–æ–≤–æ';
                document.querySelector('.app').prepend(errorDiv);
                return;
            }
            
            // –ü–µ—Ä–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
            await syncBalance(true);
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
            setInterval(() => syncBalance(false, false), 10000);
            
            console.log('‚úÖ –ì–æ—Ç–æ–≤–æ!');
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
        setTimeout(init, 500);
    </script>
</body>
</html>
