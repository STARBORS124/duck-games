<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ü¶Ü DUCK GAMES</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background: #0F172A;
            min-height: 100vh;
            padding: 16px;
            position: relative;
        }

        /* –§–æ–Ω–æ–≤—ã–µ —É—Ç–∫–∏ */
        .bg-duck {
            position: fixed;
            pointer-events: none;
            z-index: 0;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            opacity: 0.06;
        }

        .bg-duck-1 {
            top: 5%;
            left: 2%;
            width: 180px;
            height: 180px;
            background-image: url('https://avatars.mds.yandex.net/i?id=124bd57b260e8a4e4661daa0de7ad51486ff1663-9033858-images-thumbs&n=13');
            transform: rotate(-8deg);
        }

        .bg-duck-2 {
            bottom: 8%;
            right: 3%;
            width: 200px;
            height: 200px;
            background-image: url('https://i.postimg.cc/yW9QCMbb/izobrazenie-2026-02-14-182819036.png');
            transform: rotate(12deg) scaleX(-1);
        }

        .bg-duck-3 {
            top: 40%;
            left: 5%;
            width: 160px;
            height: 160px;
            background-image: url('https://avatars.mds.yandex.net/i?id=124bd57b260e8a4e4661daa0de7ad51486ff1663-9033858-images-thumbs&n=13');
            transform: rotate(5deg);
        }

        .bg-duck-4 {
            bottom: 20%;
            left: 12%;
            width: 150px;
            height: 150px;
            background-image: url('https://i.postimg.cc/yW9QCMbb/izobrazenie-2026-02-14-182819036.png');
            transform: rotate(-12deg);
        }

        .app {
            max-width: 500px;
            margin: 0 auto;
            position: relative;
            z-index: 10;
        }

        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
        .header {
            background: #1E293B;
            border-radius: 28px;
            padding: 16px 20px;
            margin-bottom: 20px;
            border: 1px solid #FBBF24;
            box-shadow: 0 8px 0 #0F172A;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .duck-icon {
            width: 44px;
            height: 44px;
            background: #FBBF24;
            border-radius: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 0 #B45309;
        }

        .logo-text {
            font-size: 22px;
            font-weight: 700;
            color: #FBBF24;
            text-shadow: 0 2px 0 #B45309;
        }

        .balance-box {
            background: #0F172A;
            border-radius: 40px;
            padding: 8px 16px;
            border: 2px solid #FBBF24;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
        }

        .balance-box.sync {
            animation: syncFlash 0.3s;
        }

        @keyframes syncFlash {
            0%, 100% { border-color: #FBBF24; }
            50% { border-color: #34D399; box-shadow: 0 0 10px #34D399; }
        }

        .star-icon {
            font-size: 20px;
            color: #FBBF24;
        }

        .balance-num {
            font-size: 22px;
            font-weight: 700;
            color: #FBBF24;
        }

        .balance-label {
            font-size: 12px;
            color: #94A3B8;
        }

        /* –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é */
        .menu-title {
            font-size: 18px;
            color: #FBBF24;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .menu-title::before {
            content: 'ü¶Ü';
            font-size: 22px;
        }

        /* –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .global-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 24px;
        }

        .global-stat-card {
            background: #1E293B;
            border-radius: 20px;
            padding: 12px 4px;
            text-align: center;
            border: 1px solid #FBBF24;
        }

        .global-stat-value {
            font-size: 18px;
            font-weight: 700;
            color: #FBBF24;
        }

        .global-stat-label {
            font-size: 10px;
            color: #94A3B8;
            margin-top: 4px;
        }

        .games-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .game-card {
            background: #1E293B;
            border-radius: 24px;
            padding: 24px 16px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
            box-shadow: 0 6px 0 #0F172A;
            text-align: center;
        }

        .game-card:hover {
            border-color: #FBBF24;
            transform: translateY(-4px);
            box-shadow: 0 10px 0 #0F172A;
        }

        .game-card:active {
            transform: translateY(2px);
            box-shadow: 0 4px 0 #0F172A;
        }

        .card-emoji {
            font-size: 56px;
            margin-bottom: 12px;
            filter: drop-shadow(0 4px 4px #00000066);
        }

        .card-name {
            font-size: 20px;
            font-weight: 700;
            color: #FBBF24;
            margin-bottom: 4px;
        }

        .card-desc {
            font-size: 13px;
            color: #94A3B8;
        }

        .card-stats {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 12px;
            font-size: 12px;
        }

        .card-stat {
            background: #0F172A;
            padding: 4px 10px;
            border-radius: 20px;
            color: #FBBF24;
        }

        /* –ú–µ–Ω—é –∏–≥—Ä—ã */
        .game-menu {
            display: none;
            background: #1E293B;
            border-radius: 28px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #FBBF24;
            box-shadow: 0 8px 0 #0F172A;
        }

        .game-menu-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid #FBBF24;
        }

        .game-menu-emoji {
            font-size: 48px;
            background: #0F172A;
            width: 80px;
            height: 80px;
            border-radius: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #FBBF24;
        }

        .game-menu-info h2 {
            font-size: 28px;
            font-weight: 700;
            color: #FBBF24;
            margin-bottom: 4px;
        }

        .game-menu-info p {
            color: #94A3B8;
            font-size: 14px;
        }

        .game-menu-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .game-menu-stat {
            background: #0F172A;
            border-radius: 16px;
            padding: 12px 4px;
            text-align: center;
            border: 1px solid #FBBF24;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: #FBBF24;
        }

        .stat-label {
            font-size: 10px;
            color: #94A3B8;
            margin-top: 4px;
        }

        .game-menu-history {
            background: #0F172A;
            border-radius: 20px;
            padding: 16px;
            margin-bottom: 20px;
            border: 1px solid #FBBF24;
        }

        .history-title {
            font-size: 16px;
            color: #FBBF24;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 16px;
            background: #1E293B;
            border-radius: 16px;
            font-size: 14px;
        }

        .history-win {
            color: #FBBF24;
            font-weight: 600;
        }

        .history-lose {
            color: #94A3B8;
        }

        .history-amount-win {
            background: #FBBF24;
            color: #0F172A;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
        }

        .history-amount-lose {
            background: #475569;
            color: #FBBF24;
            padding: 4px 12px;
            border-radius: 20px;
        }

        .game-menu-buttons {
            display: flex;
            gap: 12px;
        }

        .menu-btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 40px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .menu-btn.play {
            background: #FBBF24;
            color: #0F172A;
            box-shadow: 0 6px 0 #B45309;
        }

        .menu-btn.play:hover {
            transform: translateY(-3px);
            box-shadow: 0 9px 0 #B45309;
        }

        .menu-btn.play:active {
            transform: translateY(3px);
            box-shadow: 0 3px 0 #B45309;
        }

        .menu-btn.back {
            background: #475569;
            color: #FBBF24;
            box-shadow: 0 6px 0 #1E293B;
        }

        /* –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ */
        .game-play-area {
            display: none;
            background: #1E293B;
            border-radius: 28px;
            padding: 24px;
            border: 2px solid #FBBF24;
            box-shadow: 0 8px 0 #0F172A;
        }

        .play-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .play-title {
            font-size: 24px;
            font-weight: 700;
            color: #FBBF24;
        }

        .play-balance {
            background: #0F172A;
            padding: 8px 16px;
            border-radius: 40px;
            border: 1px solid #FBBF24;
            color: #FBBF24;
            font-weight: 600;
        }

        /* –°–ª–æ—Ç—ã */
        .slots-display {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 20px 0;
        }

        .slot-cell {
            background: #0F172A;
            border-radius: 24px;
            padding: 24px 8px;
            font-size: 48px;
            text-align: center;
            border: 2px solid #FBBF24;
            box-shadow: inset 0 -4px 0 #B45309;
        }

        /* –ö–æ—Å—Ç–∏ */
        .dice-display {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        .dice-box {
            width: 120px;
            height: 120px;
            background: #0F172A;
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 64px;
            border: 3px solid #FBBF24;
            box-shadow: 0 8px 0 #B45309;
        }

        /* –ö–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ */
        .choice-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .choice-btn {
            aspect-ratio: 1;
            background: #0F172A;
            border: 2px solid #FBBF24;
            border-radius: 20px;
            font-size: 24px;
            font-weight: 700;
            color: #FBBF24;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 0 #B45309;
        }

        .choice-btn.selected {
            background: #FBBF24;
            color: #0F172A;
            transform: translateY(2px);
            box-shadow: 0 2px 0 #B45309;
        }

        /* –ö–µ–π—Å—ã */
        .cases-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 20px 0;
        }

        .case-item {
            aspect-ratio: 1;
            background: #FBBF24;
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid #F59E0B;
            box-shadow: 0 6px 0 #B45309;
            color: #0F172A;
            font-weight: bold;
        }

        .case-item:hover {
            transform: scale(0.95);
        }

        .case-item.opened {
            background: #475569;
            border-color: #64748B;
            box-shadow: 0 4px 0 #334155;
        }

        /* –ü–æ–ª–µ —Å—Ç–∞–≤–∫–∏ */
        .bet-field {
            width: 100%;
            padding: 16px;
            background: #0F172A;
            border: 2px solid #FBBF24;
            border-radius: 40px;
            font-size: 20px;
            text-align: center;
            font-weight: 600;
            color: #FBBF24;
            margin: 15px 0;
        }

        .bet-field:focus {
            outline: none;
            border-color: #F59E0B;
            box-shadow: 0 0 0 3px #FBBF2433;
        }

        /* –ö–Ω–æ–ø–∫–∏ –∏–≥—Ä—ã */
        .game-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .game-btn {
            flex: 1;
            padding: 18px;
            border: none;
            border-radius: 40px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .game-btn.primary {
            background: #FBBF24;
            color: #0F172A;
            box-shadow: 0 6px 0 #B45309;
        }

        .game-btn.primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 9px 0 #B45309;
        }

        .game-btn.primary:active {
            transform: translateY(3px);
            box-shadow: 0 3px 0 #B45309;
        }

        .game-btn.secondary {
            background: #475569;
            color: #FBBF24;
            box-shadow: 0 6px 0 #1E293B;
        }

        /* –†–µ–∑—É–ª—å—Ç–∞—Ç */
        .game-result {
            margin-top: 16px;
            padding: 16px;
            border-radius: 40px;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            animation: resultPop 0.3s;
        }

        @keyframes resultPop {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .win-result {
            background: #FBBF2433;
            color: #FBBF24;
            border: 2px solid #FBBF24;
        }

        .lose-result {
            background: #47556933;
            color: #94A3B8;
            border: 2px solid #64748B;
        }

        /* –û—à–∏–±–∫–∞ */
        .error-msg {
            background: #7F1D1D33;
            color: #FCA5A5;
            padding: 14px;
            border-radius: 40px;
            margin: 10px 0;
            border: 2px solid #DC2626;
            text-align: center;
            animation: errorShake 0.4s;
        }

        @keyframes errorShake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #FBBF24;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <!-- –§–æ–Ω–æ–≤—ã–µ —É—Ç–∫–∏ -->
    <div class="bg-duck bg-duck-1"></div>
    <div class="bg-duck bg-duck-2"></div>
    <div class="bg-duck bg-duck-3"></div>
    <div class="bg-duck bg-duck-4"></div>

    <div class="app">
        <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
        <div class="header">
            <div class="header-top">
                <div class="logo-area">
                    <div class="duck-icon">ü¶Ü</div>
                    <div class="logo-text">DUCK GAMES</div>
                </div>
                <div class="balance-box" id="balanceBox">
                    <span class="star-icon">‚≠êÔ∏è</span>
                    <span class="balance-num" id="balanceDisplay">0</span>
                    <span class="balance-label">STARS</span>
                </div>
            </div>
        </div>

        <!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
        <div id="mainMenu">
            <!-- –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (—Ä–µ–∞–ª—å–Ω–∞—è, –æ—Ç –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤) -->
            <div class="global-stats" id="globalStats">
                <div class="global-stat-card">
                    <div class="global-stat-value" id="globalPlays">0</div>
                    <div class="global-stat-label">–í–°–ï–ì–û –ò–ì–†</div>
                </div>
                <div class="global-stat-card">
                    <div class="global-stat-value" id="globalWins">0</div>
                    <div class="global-stat-label">–ü–û–ë–ï–î</div>
                </div>
                <div class="global-stat-card">
                    <div class="global-stat-value" id="globalWinRate">0%</div>
                    <div class="global-stat-label">–í–ò–ù–†–ï–ô–¢</div>
                </div>
                <div class="global-stat-card">
                    <div class="global-stat-value" id="globalBank">0</div>
                    <div class="global-stat-label">–ë–ê–ù–ö‚≠êÔ∏è</div>
                </div>
            </div>

            <div class="menu-title">
                –í—ã–±–µ—Ä–∏ –∏–≥—Ä—É
            </div>

            <div class="games-grid">
                <!-- –°–ª–æ—Ç—ã -->
                <div class="game-card" onclick="showGameMenu('slots')">
                    <div class="card-emoji">üé∞</div>
                    <div class="card-name">–°–ª–æ—Ç—ã</div>
                    <div class="card-desc">x2 - x10 –º–Ω–æ–∂–∏—Ç–µ–ª—å</div>
                    <div class="card-stats">
                        <span class="card-stat" id="slotsGlobal">‚ö°Ô∏è 0</span>
                        <span class="card-stat" id="slotsPlayers">üë• 0</span>
                    </div>
                </div>

                <!-- –ö–æ—Å—Ç–∏ -->
                <div class="game-card" onclick="showGameMenu('dice')">
                    <div class="card-emoji">üé≤</div>
                    <div class="card-name">–ö–æ—Å—Ç–∏</div>
                    <div class="card-desc">–£–≥–∞–¥–∞–π —á–∏—Å–ª–æ x6</div>
                    <div class="card-stats">
                        <span class="card-stat" id="diceGlobal">‚ö°Ô∏è 0</span>
                        <span class="card-stat" id="dicePlayers">üë• 0</span>
                    </div>
                </div>

                <!-- –û—Ä—ë–ª/–†–µ—à–∫–∞ -->
                <div class="game-card" onclick="showGameMenu('coin')">
                    <div class="card-emoji">ü™ô</div>
                    <div class="card-name">–û—Ä—ë–ª/–†–µ—à–∫–∞</div>
                    <div class="card-desc">x2 –≤—ã–∏–≥—Ä—ã—à</div>
                    <div class="card-stats">
                        <span class="card-stat" id="coinGlobal">‚ö°Ô∏è 0</span>
                        <span class="card-stat" id="coinPlayers">üë• 0</span>
                    </div>
                </div>

                <!-- –ö–µ–π—Å—ã -->
                <div class="game-card" onclick="showGameMenu('cases')">
                    <div class="card-emoji">üéÅ</div>
                    <div class="card-name">–ö–µ–π—Å—ã</div>
                    <div class="card-desc">5-100‚≠êÔ∏è –ø—Ä–∏–∑</div>
                    <div class="card-stats">
                        <span class="card-stat" id="casesGlobal">‚ö°Ô∏è 0</span>
                        <span class="card-stat" id="casesPlayers">üë• 0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ú–µ–Ω—é –∏–≥—Ä—ã (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è) -->
        <div id="gameMenu" class="game-menu"></div>

        <!-- –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ -->
        <div id="gamePlay" class="game-play-area"></div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        let userId = tg.initDataUnsafe?.user?.id;
        let currentGame = '';
        let selectedChoice = null;
        let userBalance = 0;
        let syncInterval = null;
        let globalStats = {};
        let userStats = {};

        tg.expand();
        tg.MainButton.hide();

        // ===== –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø =====

        async function syncBalance() {
            try {
                const response = await fetch(`/api/balance?user_id=${userId}&t=${Date.now()}`);
                const data = await response.json();
                
                if (data.success) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
                    const oldBalance = userBalance;
                    userBalance = data.balance;
                    
                    // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
                    if (oldBalance !== userBalance) {
                        document.getElementById('balanceBox').classList.add('sync');
                        setTimeout(() => {
                            document.getElementById('balanceBox').classList.remove('sync');
                        }, 300);
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                    document.querySelectorAll('.balance-num, .play-balance').forEach(el => {
                        if (el) el.textContent = userBalance;
                    });
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                    if (data.global_stats) {
                        updateGlobalStats(data.global_stats);
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                    if (data.user_stats) {
                        userStats = data.user_stats;
                    }
                }
            } catch (error) {
                console.error('Sync error:', error);
            }
        }

        function updateGlobalStats(stats) {
            globalStats = stats;
            
            // –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            let totalPlays = 0;
            let totalWins = 0;
            let totalBank = 0;
            
            for (let game in stats) {
                totalPlays += stats[game].total_plays || 0;
                totalWins += stats[game].total_wins || 0;
                totalBank += stats[game].total_won || 0;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –∏–≥—Ä
                document.getElementById(`${game}Global`).textContent = `‚ö°Ô∏è ${stats[game].total_plays || 0}`;
                document.getElementById(`${game}Players`).textContent = `üë• ${Math.ceil((stats[game].total_plays || 0) / 10)}`;
            }
            
            const winRate = totalPlays > 0 ? Math.round((totalWins / totalPlays) * 100) : 0;
            
            document.getElementById('globalPlays').textContent = totalPlays;
            document.getElementById('globalWins').textContent = totalWins;
            document.getElementById('globalWinRate').textContent = winRate + '%';
            document.getElementById('globalBank').textContent = totalBank;
        }

        function startBalanceSync() {
            if (syncInterval) clearInterval(syncInterval);
            syncBalance();
            syncInterval = setInterval(syncBalance, 3000);
        }

        function stopBalanceSync() {
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
            }
        }

        async function preGameSync() {
            await syncBalance();
            return userBalance;
        }

        // ===== –ù–ê–í–ò–ì–ê–¶–ò–Ø =====

        function showGameMenu(game) {
            currentGame = game;
            
            const titles = {
                slots: { emoji: 'üé∞', name: '–°–ª–æ—Ç—ã', desc: '–ö—Ä—É—Ç–∏ –±–∞—Ä–∞–±–∞–Ω—ã –∏ –≤—ã–∏–≥—Ä—ã–≤–∞–π' },
                dice: { emoji: 'üé≤', name: '–ö–æ—Å—Ç–∏', desc: '–£–≥–∞–¥–∞–π —á–∏—Å–ª–æ –∏ –ø–æ–ª—É—á–∏ x6' },
                coin: { emoji: 'ü™ô', name: '–û—Ä—ë–ª/–†–µ—à–∫–∞', desc: '50 –Ω–∞ 50, —É–¥–≤–æ–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∏' },
                cases: { emoji: 'üéÅ', name: '–ö–µ–π—Å—ã', desc: '–û—Ç–∫—Ä—ã–≤–∞–π –∫–µ–π—Å—ã —Å –ø—Ä–∏–∑–∞–º–∏' }
            };

            // –õ–∏—á–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–∏–∑ userStats)
            const stats = userStats[game] || { played: 0, won: 0, total_won: 0, total_bet: 0 };
            const played = stats.played || 0;
            const won = stats.won || 0;
            const winRate = played > 0 ? Math.round((won / played) * 100) : 0;
            const profit = (stats.total_won || 0) - (stats.total_bet || 0);

            // –ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä (–∑–∞–≥–ª—É—à–∫–∞, –±–æ—Ç –±—É–¥–µ—Ç –ø—Ä–∏—Å—ã–ª–∞—Ç—å —Ä–µ–∞–ª—å–Ω—É—é)
            const history = [
                { result: 'win', amount: 30 },
                { result: 'lose', amount: 5 },
                { result: 'win', amount: 15 },
                { result: 'lose', amount: 10 }
            ];

            let historyHtml = '';
            history.slice(0, 5).forEach(item => {
                const isWin = item.result === 'win';
                historyHtml += `
                    <div class="history-item">
                        <span class="${isWin ? 'history-win' : 'history-lose'}">
                            ${isWin ? 'üéâ –í—ã–∏–≥—Ä—ã—à' : '‚ùå –ü—Ä–æ–∏–≥—Ä—ã—à'}
                        </span>
                        <span class="${isWin ? 'history-amount-win' : 'history-amount-lose'}">
                            ${isWin ? '+' : '-'}${Math.abs(item.amount)}‚≠êÔ∏è
                        </span>
                    </div>
                `;
            });

            const menuHtml = `
                <div class="game-menu-header">
                    <div class="game-menu-emoji">${titles[game].emoji}</div>
                    <div class="game-menu-info">
                        <h2>${titles[game].name}</h2>
                        <p>${titles[game].desc}</p>
                    </div>
                </div>
                
                <div class="game-menu-stats">
                    <div class="game-menu-stat">
                        <div class="stat-value">${played}</div>
                        <div class="stat-label">–ò–ì–†</div>
                    </div>
                    <div class="game-menu-stat">
                        <div class="stat-value">${won}</div>
                        <div class="stat-label">–ü–û–ë–ï–î</div>
                    </div>
                    <div class="game-menu-stat">
                        <div class="stat-value">${winRate}%</div>
                        <div class="stat-label">–í–ò–ù–†–ï–ô–¢</div>
                    </div>
                    <div class="game-menu-stat">
                        <div class="stat-value">${profit >= 0 ? '+' : ''}${profit}</div>
                        <div class="stat-label">–ü–†–û–§–ò–¢</div>
                    </div>
                </div>
                
                <div class="game-menu-history">
                    <div class="history-title">üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–≥—Ä—ã</div>
                    <div class="history-list">
                        ${historyHtml || '<div class="history-item">–ù–µ—Ç –∏–≥—Ä</div>'}
                    </div>
                </div>
                
                <div class="game-menu-buttons">
                    <button class="menu-btn play" onclick="startGame('${game}')">–ò–≥—Ä–∞—Ç—å</button>
                    <button class="menu-btn back" onclick="backToMainMenu()">–ù–∞–∑–∞–¥</button>
                </div>
            `;

            document.getElementById('gameMenu').innerHTML = menuHtml;
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('gameMenu').style.display = 'block';
            document.getElementById('gamePlay').style.display = 'none';
            
            syncBalance();
        }

        function startGame(game) {
            currentGame = game;
            
            const games = {
                slots: `
                    <div class="play-header">
                        <div class="play-title">üé∞ –°–ª–æ—Ç—ã</div>
                        <div class="play-balance" id="playBalance">${userBalance} ‚≠êÔ∏è</div>
                    </div>
                    <div class="slots-display" id="slotsDisplay">
                        <div class="slot-cell">‚ùì</div>
                        <div class="slot-cell">‚ùì</div>
                        <div class="slot-cell">‚ùì</div>
                    </div>
                    <input type="number" class="bet-field" id="betAmount" min="5" max="100" value="10" step="5">
                    <div style="text-align: center; color: #94A3B8; margin-bottom: 10px;">–°—Ç–∞–≤–∫–∞: 5-100 ‚≠êÔ∏è</div>
                    <div class="game-result" id="gameResult"></div>
                    <div class="game-buttons">
                        <button class="game-btn primary" onclick="playSlots()">–ö—Ä—É—Ç–∏—Ç—å</button>
                        <button class="game-btn secondary" onclick="backToGameMenu()">–ù–∞–∑–∞–¥</button>
                    </div>
                `,
                dice: `
                    <div class="play-header">
                        <div class="play-title">üé≤ –ö–æ—Å—Ç–∏</div>
                        <div class="play-balance" id="playBalance">${userBalance} ‚≠êÔ∏è</div>
                    </div>
                    <div class="dice-display">
                        <div class="dice-box" id="diceResult">üé≤</div>
                    </div>
                    <div class="choice-grid">
                        <button class="choice-btn" onclick="selectChoice(1)">1</button>
                        <button class="choice-btn" onclick="selectChoice(2)">2</button>
                        <button class="choice-btn" onclick="selectChoice(3)">3</button>
                        <button class="choice-btn" onclick="selectChoice(4)">4</button>
                        <button class="choice-btn" onclick="selectChoice(5)">5</button>
                        <button class="choice-btn" onclick="selectChoice(6)">6</button>
                    </div>
                    <input type="number" class="bet-field" id="betAmount" min="1" max="50" value="5" step="1">
                    <div style="text-align: center; color: #94A3B8; margin-bottom: 10px;">–°—Ç–∞–≤–∫–∞: 1-50 ‚≠êÔ∏è</div>
                    <div class="game-result" id="gameResult"></div>
                    <div class="game-buttons">
                        <button class="game-btn primary" onclick="playDice()">–ë—Ä–æ—Å–∏—Ç—å</button>
                        <button class="game-btn secondary" onclick="backToGameMenu()">–ù–∞–∑–∞–¥</button>
                    </div>
                `,
                coin: `
                    <div class="play-header">
                        <div class="play-title">ü™ô –û—Ä—ë–ª/–†–µ—à–∫–∞</div>
                        <div class="play-balance" id="playBalance">${userBalance} ‚≠êÔ∏è</div>
                    </div>
                    <div class="dice-display">
                        <div class="dice-box" id="coinResult">ü™ô</div>
                    </div>
                    <div class="choice-grid" style="grid-template-columns: repeat(2, 1fr);">
                        <button class="choice-btn" onclick="selectChoice('orel')">ü¶Ö</button>
                        <button class="choice-btn" onclick="selectChoice('reshka')">üí∞</button>
                    </div>
                    <input type="number" class="bet-field" id="betAmount" min="1" max="100" value="5" step="1">
                    <div style="text-align: center; color: #94A3B8; margin-bottom: 10px;">–°—Ç–∞–≤–∫–∞: 1-100 ‚≠êÔ∏è</div>
                    <div class="game-result" id="gameResult"></div>
                    <div class="game-buttons">
                        <button class="game-btn primary" onclick="playCoin()">–ë—Ä–æ—Å–∏—Ç—å</button>
                        <button class="game-btn secondary" onclick="backToGameMenu()">–ù–∞–∑–∞–¥</button>
                    </div>
                `,
                cases: `
                    <div class="play-header">
                        <div class="play-title">üéÅ –ö–µ–π—Å—ã</div>
                        <div class="play-balance" id="playBalance">${userBalance} ‚≠êÔ∏è</div>
                    </div>
                    <div class="cases-grid" id="casesGrid">
                        <div class="case-item" onclick="openCase(1)">‚ùì</div>
                        <div class="case-item" onclick="openCase(2)">‚ùì</div>
                        <div class="case-item" onclick="openCase(3)">‚ùì</div>
                    </div>
                    <div style="text-align: center; color: #FBBF24; margin: 15px 0;">–¶–µ–Ω–∞: 10 ‚≠êÔ∏è</div>
                    <div class="game-result" id="gameResult"></div>
                    <div class="game-buttons">
                        <button class="game-btn secondary" onclick="backToGameMenu()">–ù–∞–∑–∞–¥</button>
                    </div>
                `
            };

            document.getElementById('gamePlay').innerHTML = games[game];
            document.getElementById('gameMenu').style.display = 'none';
            document.getElementById('gamePlay').style.display = 'block';
            
            selectedChoice = null;
            syncBalance();
        }

        function selectChoice(choice) {
            selectedChoice = choice;
            document.querySelectorAll('.choice-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');
        }

        function showError(text) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-msg';
            errorDiv.textContent = text;
            
            const activeArea = document.getElementById('gamePlay').style.display === 'block' ? 'gamePlay' : 'gameMenu';
            const container = document.getElementById(activeArea);
            
            const oldError = container.querySelector('.error-msg');
            if (oldError) oldError.remove();
            
            container.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 3000);
        }

        // ===== –ò–ì–†–û–í–´–ï –§–£–ù–ö–¶–ò–ò =====

        async function playSlots() {
            await preGameSync();
            
            const betInput = document.getElementById('betAmount');
            const bet = betInput ? parseInt(betInput.value) : 10;

            if (bet > userBalance) {
                showError('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–≤—ë–∑–¥!');
                return;
            }

            if (bet < 5 || bet > 100) {
                showError('–°—Ç–∞–≤–∫–∞ –æ—Ç 5 –¥–æ 100 ‚≠êÔ∏è');
                return;
            }

            try {
                const response = await fetch('/api/game', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: userId,
                        action: 'slots',
                        bet: bet
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    userBalance = result.new_balance;
                    
                    document.querySelectorAll('.balance-num, .play-balance').forEach(el => {
                        if (el) el.textContent = userBalance;
                    });
                    
                    if (result.slots) {
                        document.querySelectorAll('.slot-cell').forEach((el, i) => {
                            el.textContent = result.slots[i];
                        });
                    }

                    const resultDiv = document.getElementById('gameResult');
                    resultDiv.className = `game-result ${result.win ? 'win-result' : 'lose-result'}`;
                    resultDiv.textContent = result.win ? `üéâ +${result.win_amount} ‚≠êÔ∏è` : '‚ùå –ü—Ä–æ–∏–≥—Ä—ã—à';

                    await syncBalance();
                } else {
                    showError(result.message || '–û—à–∏–±–∫–∞ –∏–≥—Ä—ã');
                }
            } catch (error) {
                console.error('Game error:', error);
                showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            }
        }

        async function playDice() {
            await preGameSync();
            
            if (!selectedChoice) {
                showError('–í—ã–±–µ—Ä–∏ —á–∏—Å–ª–æ!');
                return;
            }

            const betInput = document.getElementById('betAmount');
            const bet = betInput ? parseInt(betInput.value) : 5;

            if (bet > userBalance) {
                showError('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–≤—ë–∑–¥!');
                return;
            }

            if (bet < 1 || bet > 50) {
                showError('–°—Ç–∞–≤–∫–∞ –æ—Ç 1 –¥–æ 50 ‚≠êÔ∏è');
                return;
            }

            try {
                const response = await fetch('/api/game', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: userId,
                        action: 'dice',
                        bet: bet,
                        choice: selectedChoice
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    userBalance = result.new_balance;
                    
                    document.querySelectorAll('.balance-num, .play-balance').forEach(el => {
                        if (el) el.textContent = userBalance;
                    });
                    
                    if (result.dice_value) {
                        document.getElementById('diceResult').textContent = result.dice_value;
                    }

                    const resultDiv = document.getElementById('gameResult');
                    resultDiv.className = `game-result ${result.win ? 'win-result' : 'lose-result'}`;
                    resultDiv.textContent = result.win ? `üéâ +${result.win_amount} ‚≠êÔ∏è` : '‚ùå –ü—Ä–æ–∏–≥—Ä—ã—à';

                    await syncBalance();
                } else {
                    showError(result.message || '–û—à–∏–±–∫–∞ –∏–≥—Ä—ã');
                }
            } catch (error) {
                console.error('Game error:', error);
                showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            }
        }

        async function playCoin() {
            await preGameSync();
            
            if (!selectedChoice) {
                showError('–í—ã–±–µ—Ä–∏ —Å—Ç–æ—Ä–æ–Ω—É!');
                return;
            }

            const betInput = document.getElementById('betAmount');
            const bet = betInput ? parseInt(betInput.value) : 5;

            if (bet > userBalance) {
                showError('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–≤—ë–∑–¥!');
                return;
            }

            if (bet < 1 || bet > 100) {
                showError('–°—Ç–∞–≤–∫–∞ –æ—Ç 1 –¥–æ 100 ‚≠êÔ∏è');
                return;
            }

            try {
                const response = await fetch('/api/game', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: userId,
                        action: 'coin',
                        bet: bet,
                        choice: selectedChoice
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    userBalance = result.new_balance;
                    
                    document.querySelectorAll('.balance-num, .play-balance').forEach(el => {
                        if (el) el.textContent = userBalance;
                    });
                    
                    if (result.coin_value) {
                        document.getElementById('coinResult').textContent = 
                            result.coin_value === 'orel' ? 'ü¶Ö' : 'üí∞';
                    }

                    const resultDiv = document.getElementById('gameResult');
                    resultDiv.className = `game-result ${result.win ? 'win-result' : 'lose-result'}`;
                    resultDiv.textContent = result.win ? `üéâ +${result.win_amount} ‚≠êÔ∏è` : '‚ùå –ü—Ä–æ–∏–≥—Ä—ã—à';

                    await syncBalance();
                } else {
                    showError(result.message || '–û—à–∏–±–∫–∞ –∏–≥—Ä—ã');
                }
            } catch (error) {
                console.error('Game error:', error);
                showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            }
        }

        async function openCase(caseNum) {
            await preGameSync();
            
            if (userBalance < 10) {
                showError('–ù—É–∂–Ω–æ 10 ‚≠êÔ∏è');
                return;
            }

            try {
                const response = await fetch('/api/game', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: userId,
                        action: 'case',
                        case: caseNum
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    userBalance = result.new_balance;
                    
                    document.querySelectorAll('.balance-num, .play-balance').forEach(el => {
                        if (el) el.textContent = userBalance;
                    });

                    const caseEl = event.target;
                    caseEl.textContent = result.prize;
                    caseEl.classList.add('opened');
                    caseEl.onclick = null;

                    const resultDiv = document.getElementById('gameResult');
                    resultDiv.className = 'game-result win-result';
                    resultDiv.textContent = `üéâ +${result.prize} ‚≠êÔ∏è`;

                    await syncBalance();
                } else {
                    showError(result.message || '–û—à–∏–±–∫–∞ –∏–≥—Ä—ã');
                }
            } catch (error) {
                console.error('Game error:', error);
                showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            }
        }

        function backToMainMenu() {
            document.getElementById('mainMenu').style.display = 'block';
            document.getElementById('gameMenu').style.display = 'none';
            document.getElementById('gamePlay').style.display = 'none';
            selectedChoice = null;
            syncBalance();
        }

        function backToGameMenu() {
            if (currentGame) {
                showGameMenu(currentGame);
            } else {
                backToMainMenu();
            }
            selectedChoice = null;
            syncBalance();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        startBalanceSync();
        
        window.addEventListener('beforeunload', () => {
            stopBalanceSync();
        });
    </script>
</body>
</html>
